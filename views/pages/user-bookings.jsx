const React = require("react");
const ejs = require("ejs");
const MainLayout = require("../layouts/MainLayout");
const fallbackData = require("../utils/fallbackData");

const template = "<main>\n  <div class=\"container my-5\">\n    <div class=\"row\">\n      <div class=\"col-lg-10 mx-auto\">\n        <div class=\"card\">\n          <div class=\"card-header bg-danger text-white\">\n            <h2 class=\"mb-0\"><i class=\"fas fa-calendar-check me-2\"></i>My Bookings</h2>\n          </div>\n          <div class=\"card-body\">\n            <!-- Nav tabs -->\n            <ul class=\"nav nav-tabs\" id=\"bookingTabs\" role=\"tablist\">\n              <li class=\"nav-item\">\n                <a class=\"nav-link active\" id=\"upcoming-tab\" data-bs-toggle=\"tab\" href=\"#upcoming\" role=\"tab\">\n                  <i class=\"fas fa-calendar me-1\"></i>Upcoming\n                  <% if (upcomingBookings && upcomingBookings.length > 0) { %>\n                    <span class=\"badge bg-secondary ms-1\"><%= upcomingBookings.length %></span>\n                  <% } %>\n                </a>\n              </li>\n              <li class=\"nav-item\">\n                <a class=\"nav-link\" id=\"past-tab\" data-bs-toggle=\"tab\" href=\"#past\" role=\"tab\">\n                  <i class=\"fas fa-history me-1\"></i>Past/Cancelled\n                  <% if (pastBookings && pastBookings.length > 0) { %>\n                    <span class=\"badge bg-secondary ms-1\"><%= pastBookings.length %></span>\n                  <% } %>\n                </a>\n              </li>\n            </ul>\n\n            <!-- Tab content -->\n            <div class=\"tab-content mt-4\">\n              <!-- Upcoming Bookings -->\n              <div class=\"tab-pane fade show active\" id=\"upcoming\" role=\"tabpanel\">\n                <% if (upcomingBookings && upcomingBookings.length > 0) { %>\n                  <div class=\"table-responsive\">\n                    <table class=\"table table-hover\">\n                      <thead class=\"table-light\">\n                        <tr>\n                          <th>Trainer</th>\n                          <th>Plan</th>\n                          <th>Date & Time</th>\n                          <th>Status</th>\n                          <th>Actions</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        <% upcomingBookings.forEach(booking => { %>\n                          <tr>\n                            <td>\n                              <div class=\"d-flex align-items-center\">\n                                <% if (booking.trainer.profilePicture) { %>\n                                  <img src=\"<%= booking.trainer.profilePicture %>\" class=\"rounded-circle me-2\" width=\"40\" height=\"40\">\n                                <% } else { %>\n                                  <div class=\"bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2\" style=\"width: 40px; height: 40px;\">\n                                    <i class=\"fas fa-user-tie text-white\"></i>\n                                  </div>\n                                <% } %>\n                                <div><%= booking.trainer.name %></div>\n                              </div>\n                            </td>\n                            <td><%= booking.planTitle %></td>\n                            <td>\n                              <%= new Date(booking.startTime).toLocaleDateString() %><br>\n                              <small class=\"text-muted\"><%= new Date(booking.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %></small>\n                            </td>\n                            <td>\n                              <% if (booking.status === 'pending') { %>\n                                <span class=\"badge bg-warning\">Pending</span>\n                              <% } else if (booking.status === 'confirmed') { %>\n                                <span class=\"badge bg-success\">Confirmed</span>\n                              <% } %>\n                            </td>\n                            <td>\n                              <div class=\"btn-group\">\n                                <a href=\"/bookings/<%= booking._id %>\" class=\"btn btn-sm btn-outline-primary\">\n                                  <i class=\"fas fa-eye\"></i>\n                                </a>\n                                <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" \n                                       data-bs-toggle=\"modal\" data-bs-target=\"#cancelModal<%= booking._id %>\">\n                                  <i class=\"fas fa-times\"></i>\n                                </button>\n                              </div>\n                              \n                              <!-- Cancel Modal -->\n                              <div class=\"modal fade\" id=\"cancelModal<%= booking._id %>\" tabindex=\"-1\" aria-hidden=\"true\">\n                                <div class=\"modal-dialog\">\n                                  <div class=\"modal-content\">\n                                    <div class=\"modal-header\">\n                                      <h5 class=\"modal-title\">Cancel Booking</h5>\n                                      <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n                                    </div>\n                                    <form action=\"/user/bookings/<%= booking._id %>/cancel\" method=\"POST\">\n                                      <div class=\"modal-body\">\n                                        <p>Are you sure you want to cancel this booking?</p>\n                                        <div class=\"mb-3\">\n                                          <label for=\"cancellationReason\" class=\"form-label\">Reason (Optional)</label>\n                                          <textarea class=\"form-control\" id=\"cancellationReason\" name=\"cancellationReason\" rows=\"3\"></textarea>\n                                        </div>\n                                      </div>\n                                      <div class=\"modal-footer\">\n                                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Close</button>\n                                        <button type=\"submit\" class=\"btn btn-danger\">Confirm Cancellation</button>\n                                      </div>\n                                    </form>\n                                  </div>\n                                </div>\n                              </div>\n                            </td>\n                          </tr>\n                        <% }); %>\n                      </tbody>\n                    </table>\n                  </div>\n                <% } else { %>\n                  <div class=\"alert alert-info\">\n                    <i class=\"fas fa-info-circle me-2\"></i>You don't have any upcoming bookings.\n                    <a href=\"/plans\" class=\"alert-link\">Browse our fitness plans</a> to book a session.\n                  </div>\n                <% } %>\n              </div>\n\n              <!-- Past Bookings -->\n              <div class=\"tab-pane fade\" id=\"past\" role=\"tabpanel\">\n                <% if (pastBookings && pastBookings.length > 0) { %>\n                  <div class=\"table-responsive\">\n                    <table class=\"table table-hover\">\n                      <thead class=\"table-light\">\n                        <tr>\n                          <th>Trainer</th>\n                          <th>Plan</th>\n                          <th>Date & Time</th>\n                          <th>Status</th>\n                          <th>Actions</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        <% pastBookings.forEach(booking => { %>\n                          <tr>\n                            <td>\n                              <div class=\"d-flex align-items-center\">\n                                <% if (booking.trainer.profilePicture) { %>\n                                  <img src=\"<%= booking.trainer.profilePicture %>\" class=\"rounded-circle me-2\" width=\"40\" height=\"40\">\n                                <% } else { %>\n                                  <div class=\"bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2\" style=\"width: 40px; height: 40px;\">\n                                    <i class=\"fas fa-user-tie text-white\"></i>\n                                  </div>\n                                <% } %>\n                                <div><%= booking.trainer.name %></div>\n                              </div>\n                            </td>\n                            <td><%= booking.planTitle %></td>\n                            <td>\n                              <%= new Date(booking.startTime).toLocaleDateString() %><br>\n                              <small class=\"text-muted\"><%= new Date(booking.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %></small>\n                            </td>\n                            <td>\n                              <% if (booking.status === 'cancelled') { %>\n                                <span class=\"badge bg-danger\">Cancelled</span>\n                              <% } else if (booking.status === 'completed') { %>\n                                <span class=\"badge bg-secondary\">Completed</span>\n                              <% } else { %>\n                                <span class=\"badge bg-info\">Past</span>\n                              <% } %>\n                            </td>\n                            <td>\n                              <a href=\"/bookings/<%= booking._id %>\" class=\"btn btn-sm btn-outline-primary\">\n                                <i class=\"fas fa-eye\"></i>\n                              </a>\n                            </td>\n                          </tr>\n                        <% }); %>\n                      </tbody>\n                    </table>\n                  </div>\n                <% } else { %>\n                  <div class=\"alert alert-info\">\n                    <i class=\"fas fa-info-circle me-2\"></i>You don't have any past bookings.\n                  </div>\n                <% } %>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</main>";
const inlineScripts = ["document.addEventListener('DOMContentLoaded', function() {\n    // Handle tab navigation\n    const triggerTabList = [].slice.call(document.querySelectorAll('#bookingTabs a'));\n    triggerTabList.forEach(function(triggerEl) {\n      const tabTrigger = new bootstrap.Tab(triggerEl);\n      triggerEl.addEventListener('click', function(event) {\n        event.preventDefault();\n        tabTrigger.show();\n      });\n    });\n  });"];
const externalScripts = [];

function UserBookings(props) {
  const defaults = (fallbackData && fallbackData["user-bookings"]) || {};
  const data = { ...defaults, ...props };

  const defaultLocals = defaults.locals || {};
  const overrideLocals = props && props.locals ? props.locals : {};
  const locals = {
    ...defaultLocals,
    ...overrideLocals,
    isLoggedIn: data.isLoggedIn ?? defaultLocals.isLoggedIn ?? false,
    userRole: data.userRole ?? defaultLocals.userRole ?? "guest",
    userName: data.userName ?? defaultLocals.userName ?? "Guest",
  };

  data.locals = locals;

  let html = ejs.render(template, data);

  const collectedInlineScripts = [...inlineScripts];
  html = html.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi, (_, body) => {
    const trimmed = body.trim();
    if (trimmed.length) {
      collectedInlineScripts.push(trimmed);
    }
    return "";
  });

  return (
    <MainLayout {...data} scripts={externalScripts}>
      <div dangerouslySetInnerHTML={{ __html: html }} />
      {collectedInlineScripts.map((script, index) => (
        <script key={index} dangerouslySetInnerHTML={{ __html: script }} />
      ))}
    </MainLayout>
  );
}

module.exports = UserBookings;




